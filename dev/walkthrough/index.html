<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Walkthrough · Bigleaf.jl</title><meta name="title" content="Walkthrough · Bigleaf.jl"/><meta property="og:title" content="Walkthrough · Bigleaf.jl"/><meta property="twitter:title" content="Walkthrough · Bigleaf.jl"/><meta name="description" content="Documentation for Bigleaf.jl."/><meta property="og:description" content="Documentation for Bigleaf.jl."/><meta property="twitter:description" content="Documentation for Bigleaf.jl."/><meta property="og:url" content="https://bgctw.github.io/Bigleaf.jl/walkthrough/"/><meta property="twitter:url" content="https://bgctw.github.io/Bigleaf.jl/walkthrough/"/><link rel="canonical" href="https://bgctw.github.io/Bigleaf.jl/walkthrough/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">Bigleaf.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li class="is-active"><a class="tocitem" href>Walkthrough</a><ul class="internal"><li class="toplevel"><a class="tocitem" href="#Preparing-the-data"><span>Preparing the data</span></a></li><li class="toplevel"><a class="tocitem" href="#General-guidelines-on-package-usage"><span>General guidelines on package usage</span></a></li><li><a class="tocitem" href="#Units"><span>Units</span></a></li><li><a class="tocitem" href="#Function-arguments"><span>Function arguments</span></a></li><li><a class="tocitem" href="#Ground-heat-flux-and-storage-fluxes"><span>Ground heat flux and storage fluxes</span></a></li><li class="toplevel"><a class="tocitem" href="#Function-walkthrough"><span>Function walkthrough</span></a></li><li><a class="tocitem" href="#Data-filtering"><span>Data filtering</span></a></li><li><a class="tocitem" href="#Meteorological-variables"><span>Meteorological variables</span></a></li><li><a class="tocitem" href="#Aerodynamic-conductance"><span>Aerodynamic conductance</span></a></li><li><a class="tocitem" href="#Boundary-layer-conductance-for-trace-gases"><span>Boundary layer conductance for trace gases</span></a></li><li><a class="tocitem" href="#Surface-conductance"><span>Surface conductance</span></a></li><li><a class="tocitem" href="#Wind-profile"><span>Wind profile</span></a></li><li><a class="tocitem" href="#Potential-evapotranspiration"><span>Potential evapotranspiration</span></a></li><li><a class="tocitem" href="#Global-radiation"><span>Global radiation</span></a></li><li><a class="tocitem" href="#Unit-interconversions"><span>Unit interconversions</span></a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Walkthrough</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Walkthrough</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/bgctw/Bigleaf.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/bgctw/Bigleaf.jl/blob/main/docs/src/walkthrough.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><p>This vignette is a short introduction to the functionalities of the <code>Bigleaf.jl</code> package.  It is directed to first-time package users who are familiar with the basic concepts of Julia.  After presenting the use of several key functions of the package,  some useful hints and guidelines are given at the end of the vignette.</p><h1 id="Package-scope-and-important-conceptual-considerations"><a class="docs-heading-anchor" href="#Package-scope-and-important-conceptual-considerations">Package scope and important conceptual considerations</a><a id="Package-scope-and-important-conceptual-considerations-1"></a><a class="docs-heading-anchor-permalink" href="#Package-scope-and-important-conceptual-considerations" title="Permalink"></a></h1><p><code>Bigleaf.jl</code> calculates physical and physiological ecosystem properties from eddy  covariance data. Examples for such properties are aerodynamic and surface conductance,  surface conditions(e.g. temperature, VPD), wind profile, roughness parameters,  vegetation-atmosphere decoupling, potential evapotranspiration, (intrinsic) water-use  efficiency, stomatal sensitivity to VPD, or intercellular CO2 concentration.   All calculations in the <code>Bigleaf.jl</code> package assume that the ecosystem behaves like a   &quot;big-leaf&quot;, i.e. a single, homogeneous plane which acts as the only source and sink of the  measured fluxes. This assumption comes with the advantages that calculations are simplified  considerably and that (in most cases) little ancillary information on the EC sites is  required. It is important to keep in mind that these simplifications go hand in hand with  critical limitations. All derived variables are bulk ecosystem characteristics and have to  be interpreted as such. It is for example not possible to infer within-canopy variations  of a certain property.</p><p>Please also keep in mind that the <code>Bigleaf.jl</code> package does NOT provide formulations for  bottom-up modelling. The principle applied here is to use an inversion approach in which  ecosystem properties are inferred top-down from the measured fluxes. Such an inversion can,  in principle, be also be conducted with more complex models (e.g. sun/shade or canopy/soil  models), but keep in mind that these approaches also require that the additional,  site-specific parameters are adequately well known. </p><p>The use of more detailed models is not within the scope of the <code>Bigleaf.jl</code> package, but  it is preferable to use such approaches when important assumptions of the &quot;big-leaf&quot;  approach are not met. This is the case in particular when the ecosystem is sparsely covered  with vegetation (low LAI, e.g. sparse crops, some savanna systems). </p><h1 id="Preparing-the-data"><a class="docs-heading-anchor" href="#Preparing-the-data">Preparing the data</a><a id="Preparing-the-data-1"></a><a class="docs-heading-anchor-permalink" href="#Preparing-the-data" title="Permalink"></a></h1><p>In this tutorial, we will work with a dataset from the eddy covariance site Tharandt  (DE-Tha), a spruce forest in Eastern Germany. The DataFrame <code>DE_Tha_Jun_2014</code> is downloaded  from the <code>bigleaf</code>  <a href="https://bitbucket.org/juergenknauer/Bigleaf/">R package</a> repository and contains  half-hourly data of meteorological and flux measurements made in June 2014. For loading the  RData into Julia, see the  <a href="https://github.com/bgctw/Bigleaf.jl/blob/main/docs/src/walkthrough.md?plain=1#L26">source</a>  of this file. We give the data.frame a shorter name here and create a timestamp.</p><pre><code class="language-julia hljs">using Bigleaf
using DataFrames</code></pre><pre><code class="language-julia hljs">tha = DE_Tha_Jun_2014
set_datetime_ydh!(tha)</code></pre><p>And the first six rows of tha:</p><div class="markdown"><table><tr><th align="right">datetime</th><th align="right">year</th><th align="right">month</th><th align="right">doy</th><th align="right">hour</th><th align="right">Tair</th><th align="right">Tair_qc</th><th align="right">PPFD</th><th align="right">PPFD_qc</th><th align="right">VPD</th><th align="right">VPD_qc</th><th align="right">pressure</th><th align="right">precip</th><th align="right">precip_qc</th><th align="right">ustar</th><th align="right">wind</th><th align="right">wind_qc</th><th align="right">Ca</th><th align="right">Ca_qc</th><th align="right">LW_up</th><th align="right">LW_down</th><th align="right">Rn</th><th align="right">LE</th><th align="right">LE_qc</th><th align="right">H</th><th align="right">H_qc</th><th align="right">G</th><th align="right">G_qc</th><th align="right">NEE</th><th align="right">NEE_qc</th><th align="right">GPP</th><th align="right">GPP_qc</th><th align="right">Reco</th></tr><tr><td align="right">2014-06-01T00:00:00&#43;00:00</td><td align="right">2014</td><td align="right">6</td><td align="right">152.0</td><td align="right">0.0</td><td align="right">11.88000011444092</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.5745999813079834</td><td align="right">0.0</td><td align="right">97.63999938964844</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.5400000214576721</td><td align="right">4.210000038146973</td><td align="right">0.0</td><td align="right">402.1900024414062</td><td align="right">0.0</td><td align="right">369.4299926757812</td><td align="right">282.9299926757812</td><td align="right">-86.48999786376953</td><td align="right">9.9399995803833</td><td align="right">0.0</td><td align="right">-68.18000030517578</td><td align="right">0.0</td><td align="right">-4.934999942779541</td><td align="right">0.0</td><td align="right">9.9399995803833</td><td align="right">0.0</td><td align="right">-4.025269985198975</td><td align="right">0.0</td><td align="right">5.914730072021484</td></tr><tr><td align="right">2014-06-01T00:30:00&#43;00:00</td><td align="right">2014</td><td align="right">6</td><td align="right">152.0</td><td align="right">0.5</td><td align="right">11.67000007629395</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.5633999824523925</td><td align="right">0.0</td><td align="right">97.62999725341797</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.4900000095367432</td><td align="right">4.460000038146973</td><td align="right">0.0</td><td align="right">403.8299865722656</td><td align="right">0.0</td><td align="right">368.6700134277344</td><td align="right">284.4599914550781</td><td align="right">-84.19999694824219</td><td align="right">5.269999980926514</td><td align="right">0.0</td><td align="right">-48.54000091552734</td><td align="right">0.0</td><td align="right">-5.085000038146973</td><td align="right">0.0</td><td align="right">7.590000152587891</td><td align="right">0.0</td><td align="right">-1.722280025482178</td><td align="right">0.0</td><td align="right">5.867720127105713</td></tr><tr><td align="right">2014-06-01T01:00:00&#43;00:00</td><td align="right">2014</td><td align="right">6</td><td align="right">152.0</td><td align="right">1.0</td><td align="right">11.1899995803833</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.513700008392334</td><td align="right">0.0</td><td align="right">97.61000061035156</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.4799999892711639</td><td align="right">4.539999961853027</td><td align="right">0.0</td><td align="right">406.0</td><td align="right">0.0</td><td align="right">366.4800109863281</td><td align="right">284.6700134277344</td><td align="right">-81.80999755859375</td><td align="right">3.980000019073486</td><td align="right">0.0</td><td align="right">-59.09999847412109</td><td align="right">0.0</td><td align="right">-5.135000228881836</td><td align="right">0.0</td><td align="right">9.510000228881836</td><td align="right">0.0</td><td align="right">-3.744790077209473</td><td align="right">0.0</td><td align="right">5.765210151672363</td></tr><tr><td align="right">2014-06-01T01:30:00&#43;00:00</td><td align="right">2014</td><td align="right">6</td><td align="right">152.0</td><td align="right">1.5</td><td align="right">10.80000019073486</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.4560999870300293</td><td align="right">0.0</td><td align="right">97.61000061035156</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.449999988079071</td><td align="right">4.079999923706055</td><td align="right">0.0</td><td align="right">407.7099914550781</td><td align="right">0.0</td><td align="right">364.5700073242188</td><td align="right">286.6799926757812</td><td align="right">-77.9000015258789</td><td align="right">-6.71999979019165</td><td align="right">0.0</td><td align="right">-60.11000061035156</td><td align="right">0.0</td><td align="right">-5.210000038146973</td><td align="right">0.0</td><td align="right">8.890000343322754</td><td align="right">0.0</td><td align="right">-3.208640098571777</td><td align="right">0.0</td><td align="right">5.681369781494141</td></tr><tr><td align="right">2014-06-01T02:00:00&#43;00:00</td><td align="right">2014</td><td align="right">6</td><td align="right">152.0</td><td align="right">2.0</td><td align="right">10.67000007629395</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.4184000015258789</td><td align="right">0.0</td><td align="right">97.61000061035156</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.5099999904632568</td><td align="right">3.950000047683716</td><td align="right">0.0</td><td align="right">407.6900024414062</td><td align="right">0.0</td><td align="right">363.739990234375</td><td align="right">284.6499938964844</td><td align="right">-79.08999633789062</td><td align="right">-3.079999923706055</td><td align="right">0.0</td><td align="right">-59.40000152587891</td><td align="right">0.0</td><td align="right">-5.28000020980835</td><td align="right">0.0</td><td align="right">9.029999732971191</td><td align="right">0.0</td><td align="right">-3.37896990776062</td><td align="right">0.0</td><td align="right">5.65103006362915</td></tr><tr><td align="right">2014-06-01T02:30:00&#43;00:00</td><td align="right">2014</td><td align="right">6</td><td align="right">152.0</td><td align="right">2.5</td><td align="right">10.13000011444092</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.3608999967575073</td><td align="right">0.0</td><td align="right">97.61000061035156</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.4600000083446503</td><td align="right">4.019999980926514</td><td align="right">0.0</td><td align="right">410.1099853515625</td><td align="right">0.0</td><td align="right">361.4700012207031</td><td align="right">282.3800048828125</td><td align="right">-79.08999633789062</td><td align="right">-2.160000085830688</td><td align="right">0.0</td><td align="right">-48.91999816894531</td><td align="right">0.0</td><td align="right">-5.34499979019165</td><td align="right">0.0</td><td align="right">9.119999885559082</td><td align="right">0.0</td><td align="right">-3.583369970321655</td><td align="right">0.0</td><td align="right">5.536640167236328</td></tr></table>
</div><p>More information on the data (e.g. meaning of column names and units) can be found at the  <a href="https://bitbucket.org/juergenknauer/bigleaf/src/master/man/DE_Tha_Jun_2014.Rd">bigleaf R package</a>.  For more information on the site see e.g. Grünwald &amp; Bernhofer 2007. In addition, we will need some ancillary data for this site throughout this tutorial. To ensure consistency, we define them here at the beginning:</p><pre><code class="language-julia hljs">thal = (
     LAI = 7.6,   # leaf area index
     zh  = 26.5,  # average vegetation height (m)
     zr  = 42,    # sensor height (m)
     Dl  = 0.01,  # leaf characteristic dimension (m)
)</code></pre><h1 id="General-guidelines-on-package-usage"><a class="docs-heading-anchor" href="#General-guidelines-on-package-usage">General guidelines on package usage</a><a id="General-guidelines-on-package-usage-1"></a><a class="docs-heading-anchor-permalink" href="#General-guidelines-on-package-usage" title="Permalink"></a></h1><p>There are a few general guidelines that are important to consider when using the <code>Bigleaf.jl</code> package. </p><h2 id="Units"><a class="docs-heading-anchor" href="#Units">Units</a><a id="Units-1"></a><a class="docs-heading-anchor-permalink" href="#Units" title="Permalink"></a></h2><p>It is imperative that variables are provided in the right units, as the plausibility of  the input units is not checked in most cases. The required units of the input arguments  can be found in the respective help file of the function. The good news is that units  do not change across functions. For example, pressure is always required in kPa,  and temperature always in °C.</p><h2 id="Function-arguments"><a class="docs-heading-anchor" href="#Function-arguments">Function arguments</a><a id="Function-arguments-1"></a><a class="docs-heading-anchor-permalink" href="#Function-arguments" title="Permalink"></a></h2><p><code>Bigleaf.jl</code> usually provides functions in two flavours.</p><ul><li>providing all arguments separately as scalars and output being a single scalar or a NamedTuple</li><li>providing a DataFrame as first argument with columns corresponding to the inputs and  output being the in-place modified DataFrame. Most keyword arguments accept both, vectors or scalars. The column names in the DataFrame should correspond to the argument names of the corresponding method with individual inputs.</li></ul><p>We can demonstrate the usage with a simple example:</p><pre><code class="language-julia hljs"># explicit inputs
Tair, pressure, Rn, =  14.81, 97.71, 778.17
potential_ET(PriestleyTaylor(), Tair, pressure, Rn)

# DataFrame
potential_ET!(copy(tha), PriestleyTaylor())

# DataFrame with a few columns overwritten by user values
potential_ET!(transform(tha, :Tair =&gt; x -&gt; 25.0; renamecols=false), PriestleyTaylor())

# varying one input only: scalar form with dot-notation
Tair_vec =  10.0:1.0:20.0
DataFrame(potential_ET.(Ref(PriestleyTaylor()), Tair_vec, pressure, Rn))</code></pre><p>For functions operating only on vectors, e.g. <a href="../surface_roughness/#Bigleaf.roughness_parameters"><code>roughness_parameters</code></a> vectors are provided with the individual inputs. Sometimes, an additional  non-mutating DataFrame  variant is provided for convenience, however, the output value of this variant is  not type-stable.</p><h2 id="Ground-heat-flux-and-storage-fluxes"><a class="docs-heading-anchor" href="#Ground-heat-flux-and-storage-fluxes">Ground heat flux and storage fluxes</a><a id="Ground-heat-flux-and-storage-fluxes-1"></a><a class="docs-heading-anchor-permalink" href="#Ground-heat-flux-and-storage-fluxes" title="Permalink"></a></h2><p>Many functions require the available energy (<span>$A$</span>), which is defined as (<span>$A = R_n - G - S$</span>,  all in <span>$\text{W m}^{-2}$</span>), where <span>$R_n$</span> is the net radiation, <span>$G$</span> is the ground heat flux,  and <span>$S$</span> is the sum of all storage fluxes of the ecosystem  (see e.g. Leuning et al. 2012 for an overview). For some sites, <span>$G$</span> is not available,  and for most sites, only a few components of <span>$S$</span> are measured. </p><p>In <code>Bigleaf.jl</code> it is not a problem if <span>$G$</span> and/or <span>$S$</span> are missing (other than the results  might be (slightly) biased), but special options exist for the treatment of missing  <span>$S$</span> and <span>$G$</span> values. </p><p>Note that the default for G and S in the dataframe variant is missing (and assumed zero),  even if those columns are present in the DataFrame. You need to explicitly pass those columns with the optional arguments: e.g. <code>potential_ET(df, PriestleyTaylor(); G = df.G)</code></p><p>Note that in difference to the bigleaf R package missing entries in an input vector are not relaced by zero by default.  You need to explicitly use coalesce when specifying a ground heat flux for which missings should be replaced by zero: <code>;G = coalesce(df.G, zero(df.G))</code></p><h1 id="Function-walkthrough"><a class="docs-heading-anchor" href="#Function-walkthrough">Function walkthrough</a><a id="Function-walkthrough-1"></a><a class="docs-heading-anchor-permalink" href="#Function-walkthrough" title="Permalink"></a></h1><h2 id="Data-filtering"><a class="docs-heading-anchor" href="#Data-filtering">Data filtering</a><a id="Data-filtering-1"></a><a class="docs-heading-anchor-permalink" href="#Data-filtering" title="Permalink"></a></h2><p>For most applications it is meaningful to filter your data. There are two main reasons  why we want to filter our data before we start calculating ecosystem properties.  The first one is to exclude datapoints that do not fulfill the requirements of the  EC technique or that are of bad quality due to e.g. instrument failure or gap-filling  with poor confidence. Note that the quality assessment of the EC data is not the purpose  of the <code>Bigleaf.jl</code> package. This is done by other packages (e.g. <code>REddyProc</code>),  which often provide quality control flags for the variables. These quality control  flags are used here to filter out bad-quality datapoints.</p><p>A second reason for filtering our data is that some derived properties are only  meaningful if certain meteorological conditions are met. For instance, if we are  interested in properties related to plant gas exchange, it makes most sense to focus on  time periods when plants are photosynthetically active  (i.e. in the growing season and at daytime).</p><p><code>Bigleaf.jl</code> provides methods that update (or create) the :valid column in  a DataFrame. Records, i.e. rows, that contain non valid conditions are set to false. If the valid column was false before, it stays at false.</p><h3 id="setinvalid_qualityflag!"><a class="docs-heading-anchor" href="#setinvalid_qualityflag!"><code>setinvalid_qualityflag!</code></a><a id="setinvalid_qualityflag!-1"></a><a class="docs-heading-anchor-permalink" href="#setinvalid_qualityflag!" title="Permalink"></a></h3><p>One can check quality flags. By default (argument <code>setvalmissing = true</code>) this also replaces the non-valid values in the data-columns by <code>missing</code>.</p><pre><code class="language-julia hljs">thaf = copy(tha)   # keep the original tha DataFrame
# if the :valid columns does not exist yet, it is created with all values true
setinvalid_qualityflag!(thaf; vars = [&quot;LE&quot;, &quot;NEE&quot;])
sum(.!thaf.valid) # 7 records marked non-valid
sum(ismissing.(thaf.NEE)) # 7 NEE values set to missing</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">7</code></pre><p>In the function call above, <code>vars</code> lists the variables that should be filtered with  respect to their quality. Optional parameter <code>qc_suffix=&quot;_qc&quot;</code> denotes the extension  of the variable name that identifies the column as a quality control indicator of a given  variable. The variables <code>LE</code> and <code>LE_qc</code>, for example, denote the variable itself  (latent heat flux), and the quality of the variable <code>LE</code>, respectively. The optional  argument <code>good_quality_threshold = 1.0</code> specifies the values of the quality column below which the quality control to be considered as acceptable quality  (i.e. to not be filtered). For example with default value 1,  all <code>LE</code> values whose <code>LE_qc</code> variable is larger than 1 are set to <code>missing</code>.  The variable <code>missing_qc_as_bad</code> is required to decide what to do in  case of missing values in the quality control variable. By default this is (conservatively)  set to <code>true</code>, i.e. all entries where the qc variable is missing is set invalid. </p><h3 id="setinvalid_range!"><a class="docs-heading-anchor" href="#setinvalid_range!"><code>setinvalid_range!</code></a><a id="setinvalid_range!-1"></a><a class="docs-heading-anchor-permalink" href="#setinvalid_range!" title="Permalink"></a></h3><p>We can  filter for meteorological conditions to be in acceptable ranges.  For each variable to check we supply the valid minimum and valid maximum as a two-tuple as the second component of a pair. If their is no limit towards small or large values, supply <code>-Inf</code> or <code>Inf</code> as the minimum or maximum respectively.</p><pre><code class="language-julia hljs">setinvalid_range!(thaf,
     :PPFD =&gt; (200, Inf),
     :ustar =&gt; (0.2, Inf),
     :LE =&gt;(0, Inf),
     :VPD =&gt; (0.01, Inf)
     )
sum(.!thaf.valid) # many more records marked invalid
minimum(skipmissing(thaf.PPFD)) &gt;= 200 # values outsides range some set to missing
sum(ismissing.(thaf.PPFD))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">697</code></pre><p>About half of the data were filtered because radiation was not high enough (night-time).  Another quarter was filtered because they showed negative LE values.  However, most of them occurred during the night:</p><pre><code class="language-julia hljs">sum(ismissing.(thaf.PPFD)) / nrow(thaf) # 0.48
sum(.!ismissing.(thaf.PPFD) .&amp;&amp; ismissing.(thaf.LE)) / nrow(thaf) # 0.05</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">0.05486111111111111</code></pre><h3 id="setinvalid_nongrowingseason!"><a class="docs-heading-anchor" href="#setinvalid_nongrowingseason!"><code>setinvalid_nongrowingseason!</code></a><a id="setinvalid_nongrowingseason!-1"></a><a class="docs-heading-anchor-permalink" href="#setinvalid_nongrowingseason!" title="Permalink"></a></h3><p>A third method filters periods outside the growing season:</p><pre><code class="language-julia hljs">setinvalid_nongrowingseason!(thaf, 0.4)
sum(.!thaf.valid) # tha dataset is all within growing season - no additional invalids</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">812</code></pre><p>This function implements a simple growing season filter based on daily smoothed GPP time  series.  Arguments  <code>tGPP</code> determines how high daily GPP has to be in relation to its peak value  within the year. In this case, the value of 0.4 denotes that smoothed GPP has to be at  least 40% of the 95th quantile.  Argument <code>ws</code> controls the degree of smoothing in the timeseries  and should be between 10-20 days.  The purpose of which is to minimize the high variation of GPP between days, Argument <code>min_int</code> is a parameter that avoids that data are switching from  inside the growing season and out from one day to the next.  It determines the minimum number of days that a season should have.  The growing season filter is applicable to all sites, with one more more growing seasons, but its advisable that site-specific parameter settings are used.</p><p>In this example, it does not really make sense to filter for growing season,  since it uses only one month of data of which we know that vegetation is active at the site.  The algorithm realizes that and does not mark any additional data as invalid.</p><h3 id="setinvalid_afterprecip!"><a class="docs-heading-anchor" href="#setinvalid_afterprecip!"><code>setinvalid_afterprecip!</code></a><a id="setinvalid_afterprecip!-1"></a><a class="docs-heading-anchor-permalink" href="#setinvalid_afterprecip!" title="Permalink"></a></h3><p>As a last step we will filter for precipitation events.  This is often meaningful for ecophysiological studies because data during and shortly  after rainfall events do not contain much information on the physiological activity  of the vegetation because they comprise significant fractions of evaporation from the  soil and plant surfaces. The purpose of such a filter is mostly to minimize the fraction  of soil and interception evaporation on the total water flux. This filter simply excludes  periods following a precipitation event. A precipitation event, here, is defined as any time  step with a recorded precipitation higher than <code>min_precip</code> (in mm per timestep).  The function then filters all time periods following a precipitation event.  The number of subsequent time periods excluded is controlled by the argument <code>precip_hours</code>.  Here, we exclude rainfall events and the following 24 hours. The timestamps in the DataFrame must be sorted in increasing order.</p><pre><code class="language-julia hljs">setinvalid_afterprecip!(thaf; min_precip=0.02, hours_after=24)
sum(.!thaf.valid) # some more invalids</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">1013</code></pre><p>In this walkthrough we use the data as filtered above:</p><pre><code class="language-julia hljs">thas = subset(thaf, :valid)
nrow(thas)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">427</code></pre><p>With first 6 rows:</p><div class="markdown"><table><tr><th align="right">datetime</th><th align="right">year</th><th align="right">month</th><th align="right">doy</th><th align="right">hour</th><th align="right">Tair</th><th align="right">Tair_qc</th><th align="right">PPFD</th><th align="right">PPFD_qc</th><th align="right">VPD</th><th align="right">VPD_qc</th><th align="right">pressure</th><th align="right">precip</th><th align="right">precip_qc</th><th align="right">ustar</th><th align="right">wind</th><th align="right">wind_qc</th><th align="right">Ca</th><th align="right">Ca_qc</th><th align="right">LW_up</th><th align="right">LW_down</th><th align="right">Rn</th><th align="right">LE</th><th align="right">LE_qc</th><th align="right">H</th><th align="right">H_qc</th><th align="right">G</th><th align="right">G_qc</th><th align="right">NEE</th><th align="right">NEE_qc</th><th align="right">GPP</th><th align="right">GPP_qc</th><th align="right">Reco</th><th align="right">valid</th></tr><tr><td align="right">2014-06-01T05:30:00&#43;00:00</td><td align="right">2014</td><td align="right">6</td><td align="right">152.0</td><td align="right">5.5</td><td align="right">8.899999618530273</td><td align="right">0.0</td><td align="right">283.1900024414062</td><td align="right">0.0</td><td align="right">0.3075999975204468</td><td align="right">0.0</td><td align="right">97.69000244140625</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.5099999904632568</td><td align="right">2.970000028610229</td><td align="right">0.0</td><td align="right">414.9200134277344</td><td align="right">0.0</td><td align="right">358.3500061035156</td><td align="right">303.1000061035156</td><td align="right">78.0</td><td align="right">27.3700008392334</td><td align="right">0.0</td><td align="right">2.400000095367432</td><td align="right">0.0</td><td align="right">-6.039999961853027</td><td align="right">0.0</td><td align="right">-5.800000190734863</td><td align="right">0.0</td><td align="right">11.06429958343506</td><td align="right">0.0</td><td align="right">5.264339923858643</td><td align="right">true</td></tr><tr><td align="right">2014-06-01T06:00:00&#43;00:00</td><td align="right">2014</td><td align="right">6</td><td align="right">152.0</td><td align="right">6.0</td><td align="right">9.430000305175781</td><td align="right">0.0</td><td align="right">373.239990234375</td><td align="right">0.0</td><td align="right">0.3339999914169312</td><td align="right">0.0</td><td align="right">97.69000244140625</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.5199999809265137</td><td align="right">3.349999904632568</td><td align="right">0.0</td><td align="right">411.3299865722656</td><td align="right">0.0</td><td align="right">361.6700134277344</td><td align="right">299.6700134277344</td><td align="right">113.2399978637695</td><td align="right">23.52000045776367</td><td align="right">0.0</td><td align="right">38.29999923706055</td><td align="right">0.0</td><td align="right">-5.034999847412109</td><td align="right">0.0</td><td align="right">-6.889999866485596</td><td align="right">0.0</td><td align="right">12.25899982452393</td><td align="right">0.0</td><td align="right">5.368969917297363</td><td align="right">true</td></tr><tr><td align="right">2014-06-01T06:30:00&#43;00:00</td><td align="right">2014</td><td align="right">6</td><td align="right">152.0</td><td align="right">6.5</td><td align="right">9.710000038146973</td><td align="right">0.0</td><td align="right">404.7000122070312</td><td align="right">0.0</td><td align="right">0.3270999908447266</td><td align="right">0.0</td><td align="right">97.69999694824219</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.4099999964237213</td><td align="right">2.660000085830688</td><td align="right">0.0</td><td align="right">409.1900024414062</td><td align="right">0.0</td><td align="right">363.4700012207031</td><td align="right">299.4700012207031</td><td align="right">121.9499969482422</td><td align="right">6.639999866485596</td><td align="right">0.0</td><td align="right">38.45000076293945</td><td align="right">0.0</td><td align="right">-4.070000171661377</td><td align="right">0.0</td><td align="right">-7.699999809265137</td><td align="right">0.0</td><td align="right">13.12259960174561</td><td align="right">0.0</td><td align="right">5.422589778900146</td><td align="right">true</td></tr><tr><td align="right">2014-06-01T07:00:00&#43;00:00</td><td align="right">2014</td><td align="right">6</td><td align="right">152.0</td><td align="right">7.0</td><td align="right">10.55000019073486</td><td align="right">0.0</td><td align="right">602.3800048828125</td><td align="right">0.0</td><td align="right">0.373799991607666</td><td align="right">0.0</td><td align="right">97.70999908447266</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.5400000214576721</td><td align="right">2.779999971389771</td><td align="right">0.0</td><td align="right">404.3699951171875</td><td align="right">0.0</td><td align="right">368.4100036621094</td><td align="right">313.4400024414062</td><td align="right">230.6199951171875</td><td align="right">52.2599983215332</td><td align="right">0.0</td><td align="right">85.08000183105469</td><td align="right">0.0</td><td align="right">-3.019999980926514</td><td align="right">0.0</td><td align="right">-13.75</td><td align="right">0.0</td><td align="right">19.34040069580078</td><td align="right">0.0</td><td align="right">5.590370178222656</td><td align="right">true</td></tr><tr><td align="right">2014-06-01T07:30:00&#43;00:00</td><td align="right">2014</td><td align="right">6</td><td align="right">152.0</td><td align="right">7.5</td><td align="right">11.19999980926514</td><td align="right">0.0</td><td align="right">675.1900024414062</td><td align="right">0.0</td><td align="right">0.4267000198364258</td><td align="right">0.0</td><td align="right">97.69999694824219</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.4600000083446503</td><td align="right">2.329999923706055</td><td align="right">0.0</td><td align="right">401.3699951171875</td><td align="right">0.0</td><td align="right">372.6499938964844</td><td align="right">346.1099853515625</td><td align="right">302.1700134277344</td><td align="right">54.02000045776367</td><td align="right">0.0</td><td align="right">108.7799987792969</td><td align="right">0.0</td><td align="right">-1.475000023841858</td><td align="right">0.0</td><td align="right">-19.29000091552734</td><td align="right">0.0</td><td align="right">25.00930023193359</td><td align="right">0.0</td><td align="right">5.719329833984375</td><td align="right">true</td></tr><tr><td align="right">2014-06-01T08:00:00&#43;00:00</td><td align="right">2014</td><td align="right">6</td><td align="right">152.0</td><td align="right">8.0</td><td align="right">11.72999954223633</td><td align="right">0.0</td><td align="right">989.489990234375</td><td align="right">0.0</td><td align="right">0.4580999851226807</td><td align="right">0.0</td><td align="right">97.7300033569336</td><td align="right">0.0</td><td align="right">0.0</td><td align="right">0.5099999904632568</td><td align="right">2.220000028610229</td><td align="right">0.0</td><td align="right">400.9299926757812</td><td align="right">0.0</td><td align="right">376.6000061035156</td><td align="right">299.6900024414062</td><td align="right">394.5400085449219</td><td align="right">92.27999877929688</td><td align="right">0.0</td><td align="right">176.6799926757812</td><td align="right">0.0</td><td align="right">0.5550000071525574</td><td align="right">0.0</td><td align="right">-20.52000045776367</td><td align="right">0.0</td><td align="right">26.34370040893555</td><td align="right">0.0</td><td align="right">5.823709964752197</td><td align="right">true</td></tr></table>
</div><h2 id="Meteorological-variables"><a class="docs-heading-anchor" href="#Meteorological-variables">Meteorological variables</a><a id="Meteorological-variables-1"></a><a class="docs-heading-anchor-permalink" href="#Meteorological-variables" title="Permalink"></a></h2><p>The <code>Bigleaf.jl</code> package provides calculation routines for a number of meteorological variables, which are basic to the calculation of many other variables. A few examples on their usage are given below:</p><pre><code class="language-julia hljs"># Saturation vapor pressure (kPa) and slope of the saturation vapor pressure curve (kPa K-1)
Esat_slope(25.0)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">(3.1600569164883336, 0.18830553015839052)</code></pre><pre><code class="language-julia hljs"># psychrometric constant (kPa K-1)
psychrometric_constant(25.0,100.0) # Tair, pressure</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">0.06616110355198965</code></pre><pre><code class="language-julia hljs"># air density (kg m-3)
air_density(25.0,100.0) # Tair, pressure</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">1.1684082743664639</code></pre><pre><code class="language-julia hljs"># dew point (degC)
dew_point(25.0,1.0) # Tair, VPD</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">18.764</code></pre><pre><code class="language-julia hljs"># wetbulb temperature (degC)
wetbulb_temp(25.0, 100.0, 1.0) # Tair, pressure, VPD</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">20.648</code></pre><pre><code class="language-julia hljs"># estimate atmospheric pressure from elevation (hypsometric equation)
pressure_from_elevation(500.0, 25.0) # elev, Tair</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">95.68128752221739</code></pre><p>There are several formulations describing the empirical function <code>Esat(Tair)</code>. The following figure compares them at absole scale and as difference to the  #default method. The differences are small.</p><p><img src="../fig/Esat_abs.svg" alt/></p><p><img src="../fig/Esat_rel.svg" alt/></p><h2 id="Aerodynamic-conductance"><a class="docs-heading-anchor" href="#Aerodynamic-conductance">Aerodynamic conductance</a><a id="Aerodynamic-conductance-1"></a><a class="docs-heading-anchor-permalink" href="#Aerodynamic-conductance" title="Permalink"></a></h2><p>An important metric for many calculations in the <code>Bigleaf.jl</code> package is the aerodynamic  conductance (<span>$G_a$</span>) between the land surface and the measurement height. <span>$G_a$</span>  characterizes how efficiently mass and energy is transferred between the land surface  and the atmosphere. <span>$G_a$</span> consists of two parts: <span>$G_{a_m}$</span>, the aerodynamic conductance  for momentum, and <span>$G_b$</span>, the canopy boundary layer (or quasi-laminar) conductance.  <span>$G_a$</span> can be defined as </p><p><span>$G_a = 1/(1/G_{a_m} + 1/G_b)$</span>. </p><p>In this tutorial we will focus on  how to use the function <a href="../aerodynamic_conductance/#Bigleaf.aerodynamic_conductance!"><code>aerodynamic_conductance!</code></a>.  For further details on the equations,  the reader is directed to the publication of the Bigleaf package (Knauer et al. 2018) and  the references therein. A good overview is provided by e.g. Verma 1989.</p><p><span>$G_a$</span> and in particular <span>$G_b$</span> can be calculated with varying degrees of complexity.  We start with the simplest version, in which <span>$G_b$</span> is calculated empirically based on  the friction velocity (<span>$u_*$</span>) according to Thom 1972:</p><pre><code class="language-julia hljs">aerodynamic_conductance!(thas);
thas[1:3, Cols(:datetime,Between(:zeta,:Ga_CO2))]</code></pre><div><div style = "float: left;"><span>3×13 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "header"><th class = "rowNumber" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">datetime</th><th style = "text-align: left;">zeta</th><th style = "text-align: left;">psi_h</th><th style = "text-align: left;">psi_m</th><th style = "text-align: left;">Gb_h</th><th style = "text-align: left;">Rb_h</th><th style = "text-align: left;">kB_h</th><th style = "text-align: left;">Gb_CO2</th><th style = "text-align: left;">Ra_m</th><th style = "text-align: left;">Ga_m</th><th style = "text-align: left;">Ga_h</th><th style = "text-align: left;">Ra_h</th><th style = "text-align: left;">Ga_CO2</th></tr><tr class = "subheader headerLastRow"><th class = "rowNumber" style = "font-weight: bold; text-align: right;"></th><th title = "TimeZones.ZonedDateTime" style = "text-align: left;">ZonedDat…</th><th title = "Missing" style = "text-align: left;">Missing</th><th title = "Missing" style = "text-align: left;">Missing</th><th title = "Missing" style = "text-align: left;">Missing</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th></tr></thead><tbody><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: left;">2014-06-01T05:30:00+00:00</td><td style = "font-style: italic; text-align: right;">missing</td><td style = "font-style: italic; text-align: right;">missing</td><td style = "font-style: italic; text-align: right;">missing</td><td style = "text-align: right;">0.102934</td><td style = "text-align: right;">9.71499</td><td style = "text-align: right;">2.0314</td><td style = "text-align: right;">0.0782012</td><td style = "text-align: right;">11.4187</td><td style = "text-align: right;">0.0875758</td><td style = "text-align: right;">0.0473178</td><td style = "text-align: right;">21.1337</td><td style = "text-align: right;">0.0413117</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: left;">2014-06-01T06:00:00+00:00</td><td style = "font-style: italic; text-align: right;">missing</td><td style = "font-style: italic; text-align: right;">missing</td><td style = "font-style: italic; text-align: right;">missing</td><td style = "text-align: right;">0.104276</td><td style = "text-align: right;">9.58997</td><td style = "text-align: right;">2.04458</td><td style = "text-align: right;">0.0792207</td><td style = "text-align: right;">12.3891</td><td style = "text-align: right;">0.0807164</td><td style = "text-align: right;">0.0454979</td><td style = "text-align: right;">21.979</td><td style = "text-align: right;">0.0399808</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: left;">2014-06-01T06:30:00+00:00</td><td style = "font-style: italic; text-align: right;">missing</td><td style = "font-style: italic; text-align: right;">missing</td><td style = "font-style: italic; text-align: right;">missing</td><td style = "text-align: right;">0.0889888</td><td style = "text-align: right;">11.2374</td><td style = "text-align: right;">1.889</td><td style = "text-align: right;">0.0676069</td><td style = "text-align: right;">15.8239</td><td style = "text-align: right;">0.0631955</td><td style = "text-align: right;">0.0369532</td><td style = "text-align: right;">27.0613</td><td style = "text-align: right;">0.0326634</td></tr></tbody></table></div><p>Note that by not providing additional arguments, the default values are taken. We also do not need most of the arguments that can be provided to the function in this case  (i.e. with <code>Gb_model=Thom1972()</code>). These are only required if we use a more complex  formulation of <span>$G_b$</span>. The output of the function is another DataFrame which contains separate columns for  conductances and resistances of different scalars (momentum, heat, and <span>$CO_2$</span> by default).</p><p>For comparison, we now calculate a second estimate of <span>$G_a$</span>, where the calculation of  <span>$G_b$</span> is more physically-based (Su et al. 2001), and which requires more input variables  compared to the first version. In particular, we now need LAI, the leaf characteristic  dimension (<span>$D_l$</span>, assumed to be 1cm here), and information on sensor and canopy height  (<span>$z_r$</span> and <span>$z_h$</span>), as well as the displacement height (assumed to be 0.7*<span>$z_h$</span>):</p><pre><code class="language-julia hljs">aerodynamic_conductance!(thas;Gb_model=Su2001(),
     LAI=thal.zh, zh=thal.zh, d=0.7*thal.zh, zr=thal.zr, Dl=thal.Dl);
thas[1:3, Cols(:datetime,Between(:zeta,:Ga_CO2))]</code></pre><div><div style = "float: left;"><span>3×13 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "header"><th class = "rowNumber" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">datetime</th><th style = "text-align: left;">zeta</th><th style = "text-align: left;">psi_h</th><th style = "text-align: left;">psi_m</th><th style = "text-align: left;">Gb_h</th><th style = "text-align: left;">Rb_h</th><th style = "text-align: left;">kB_h</th><th style = "text-align: left;">Gb_CO2</th><th style = "text-align: left;">Ra_m</th><th style = "text-align: left;">Ga_m</th><th style = "text-align: left;">Ga_h</th><th style = "text-align: left;">Ra_h</th><th style = "text-align: left;">Ga_CO2</th></tr><tr class = "subheader headerLastRow"><th class = "rowNumber" style = "font-weight: bold; text-align: right;"></th><th title = "TimeZones.ZonedDateTime" style = "text-align: left;">ZonedDat…</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th></tr></thead><tbody><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: left;">2014-06-01T05:30:00+00:00</td><td style = "text-align: right;">-0.00499025</td><td style = "text-align: right;">0.0387771</td><td style = "text-align: right;">0.0386849</td><td style = "text-align: right;">0.172682</td><td style = "text-align: right;">5.79098</td><td style = "text-align: right;">1.21089</td><td style = "text-align: right;">0.131191</td><td style = "text-align: right;">11.4187</td><td style = "text-align: right;">0.0875758</td><td style = "text-align: right;">0.0581069</td><td style = "text-align: right;">17.2097</td><td style = "text-align: right;">0.0525178</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: left;">2014-06-01T06:00:00+00:00</td><td style = "text-align: right;">-0.0751295</td><td style = "text-align: right;">0.433396</td><td style = "text-align: right;">0.423769</td><td style = "text-align: right;">0.204536</td><td style = "text-align: right;">4.88912</td><td style = "text-align: right;">1.04236</td><td style = "text-align: right;">0.155391</td><td style = "text-align: right;">12.3891</td><td style = "text-align: right;">0.0807164</td><td style = "text-align: right;">0.0578765</td><td style = "text-align: right;">17.2782</td><td style = "text-align: right;">0.0531224</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: left;">2014-06-01T06:30:00+00:00</td><td style = "text-align: right;">-0.153859</td><td style = "text-align: right;">0.715751</td><td style = "text-align: right;">0.692316</td><td style = "text-align: right;">0.21226</td><td style = "text-align: right;">4.7112</td><td style = "text-align: right;">0.791953</td><td style = "text-align: right;">0.161259</td><td style = "text-align: right;">15.8239</td><td style = "text-align: right;">0.0631955</td><td style = "text-align: right;">0.0486971</td><td style = "text-align: right;">20.5351</td><td style = "text-align: right;">0.0454027</td></tr></tbody></table></div><p>We see that the values are different compared to the first, empirical estimate.  This is because this formulation takes additional aerodynamically relevant properties  (LAI, <span>$D_l$</span>) into account that were not considered by the simple empirical formulation.</p><h2 id="Boundary-layer-conductance-for-trace-gases"><a class="docs-heading-anchor" href="#Boundary-layer-conductance-for-trace-gases">Boundary layer conductance for trace gases</a><a id="Boundary-layer-conductance-for-trace-gases-1"></a><a class="docs-heading-anchor-permalink" href="#Boundary-layer-conductance-for-trace-gases" title="Permalink"></a></h2><p>By default, the function <code>aerodynamic_conductance</code> (calling <code>compute_Gb!</code>) returns the  (quasi-laminar) canopy boundary layer (<span>$G_{b}$</span>) for heat and water vapor  (which are assumed to be equal in the <code>Bigleaf.jl</code>), as well as for CO<span>$_2$</span>.  Function <code>add_Gb</code> calculates <span>$G_b$</span> for other trace gases, provided that the respective Schmidt  number is known. </p><pre><code class="language-julia hljs">compute_Gb!(thas, Thom1972()); # adds/modifies column Gb_h and Gb_CO2
add_Gb!(thas, :Gb_O2 =&gt; 0.84, :Gb_CH4 =&gt; 0.99); # adds Gb_O2 and Gb_CH4
select(first(thas,3), r&quot;Gb_&quot;)</code></pre><div><div style = "float: left;"><span>3×4 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "header"><th class = "rowNumber" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">Gb_h</th><th style = "text-align: left;">Gb_CO2</th><th style = "text-align: left;">Gb_Gb_O2</th><th style = "text-align: left;">Gb_Gb_CH4</th></tr><tr class = "subheader headerLastRow"><th class = "rowNumber" style = "font-weight: bold; text-align: right;"></th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th></tr></thead><tbody><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: right;">0.102934</td><td style = "text-align: right;">0.131191</td><td style = "text-align: right;">0.0919673</td><td style = "text-align: right;">0.0823806</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: right;">0.104276</td><td style = "text-align: right;">0.155391</td><td style = "text-align: right;">0.0931662</td><td style = "text-align: right;">0.0834546</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: right;">0.0889888</td><td style = "text-align: right;">0.161259</td><td style = "text-align: right;">0.0795081</td><td style = "text-align: right;">0.0712201</td></tr></tbody></table></div><h2 id="Surface-conductance"><a class="docs-heading-anchor" href="#Surface-conductance">Surface conductance</a><a id="Surface-conductance-1"></a><a class="docs-heading-anchor-permalink" href="#Surface-conductance" title="Permalink"></a></h2><p>Knowledge of aerodynamic conductance <span>$G_a$</span>  allows us to calculate the bulk surface conductance (<span>$G_s$</span>) of the site  (In this case by inverting the Penman-Monteith equation). Gs represents the combined  conductance of the vegetation and the soil to water vapor transfer (and as such it is not  a purely physiological quantity). Calculating <span>$G_s$</span> in <code>Bigleaf.jl</code> is simple:</p><pre><code class="language-julia hljs">surface_conductance!(thas, InversePenmanMonteith());
thas[1:3,Cols(:datetime, r&quot;Gs&quot;)]</code></pre><div><div style = "float: left;"><span>3×3 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "header"><th class = "rowNumber" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">datetime</th><th style = "text-align: left;">Gs_ms</th><th style = "text-align: left;">Gs_mol</th></tr><tr class = "subheader headerLastRow"><th class = "rowNumber" style = "font-weight: bold; text-align: right;"></th><th title = "TimeZones.ZonedDateTime" style = "text-align: left;">ZonedDat…</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th></tr></thead><tbody><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: left;">2014-06-01T05:30:00+00:00</td><td style = "text-align: right;">0.00424948</td><td style = "text-align: right;">0.17702</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: left;">2014-06-01T06:00:00+00:00</td><td style = "text-align: right;">0.00298804</td><td style = "text-align: right;">0.124239</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: left;">2014-06-01T06:30:00+00:00</td><td style = "text-align: right;">0.000732206</td><td style = "text-align: right;">0.0304172</td></tr></tbody></table></div><p>The two columns only differ in the unit of <span>$G_s$</span>.  One in m s<span>$^{-1}$</span> and one in mol m<span>$^{-2}$</span> s<span>$^{-1}$</span>.  In this function we have ignored the ground heat flux (<span>$G$</span>) and the storage fluxes (<span>$S$</span>). By default they are assumed zero. In our example we do not have information on the storage fluxes, but we have measurements  on the ground heat flux, which we should add to the function call:</p><pre><code class="language-julia hljs">surface_conductance!(thas, InversePenmanMonteith(); G=thas.G);
thas[1:3,Cols(:datetime, r&quot;Gs&quot;)]</code></pre><div><div style = "float: left;"><span>3×3 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "header"><th class = "rowNumber" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">datetime</th><th style = "text-align: left;">Gs_ms</th><th style = "text-align: left;">Gs_mol</th></tr><tr class = "subheader headerLastRow"><th class = "rowNumber" style = "font-weight: bold; text-align: right;"></th><th title = "TimeZones.ZonedDateTime" style = "text-align: left;">ZonedDat…</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th></tr></thead><tbody><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: left;">2014-06-01T05:30:00+00:00</td><td style = "text-align: right;">0.0041683</td><td style = "text-align: right;">0.173638</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: left;">2014-06-01T06:00:00+00:00</td><td style = "text-align: right;">0.00294749</td><td style = "text-align: right;">0.122553</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: left;">2014-06-01T06:30:00+00:00</td><td style = "text-align: right;">0.000723767</td><td style = "text-align: right;">0.0300667</td></tr></tbody></table></div><h2 id="Wind-profile"><a class="docs-heading-anchor" href="#Wind-profile">Wind profile</a><a id="Wind-profile-1"></a><a class="docs-heading-anchor-permalink" href="#Wind-profile" title="Permalink"></a></h2><p>The &#39;big-leaf&#39; framework assumes that wind speed is zero at height d + <span>$z_{0m}$</span>  (where <span>$z_{0m}$</span> is the roughness length for momentum) and then increases exponentially with  height. The shape of the wind profile further depends on the stability conditions of the  air above the canopy. In <code>Bigleaf.jl</code>, a wind profile can be calculated assuming an exponential increase with  height, which is affected by atmospheric stability. Here, we calculate wind speed at  heights of 22-60m in steps of 2m. As expected, the gradient in wind speed is strongest  close to the surface and weaker at greater heights:</p><pre><code class="language-julia hljs">using Statistics
wind_heights = 22:2:60.0
d = 0.7 * thal.zh
z0m = roughness_parameters(Roughness_wind_profile(), thas; zh=thal.zh, zr=thal.zr).z0m
wp = map(wind_heights) do z
  wind_profile(z, thas,d, z0m)
end;</code></pre><img src="e5b593ce.svg" alt="Example block output"/><p>Here, the points denote the mean wind speed and the bars denote the standard deviation across time. The blue point/bar represent the values that were measured at zr = 42m.  In this case we see that the wind speed as &quot;back-calculated&quot; from the wind profile agrees  well with the actual measurements.</p><h2 id="Potential-evapotranspiration"><a class="docs-heading-anchor" href="#Potential-evapotranspiration">Potential evapotranspiration</a><a id="Potential-evapotranspiration-1"></a><a class="docs-heading-anchor-permalink" href="#Potential-evapotranspiration" title="Permalink"></a></h2><p>For many hydrological applications, it is relevant to get an estimate on the potential  evapotranspiration (PET). At the moment, the <code>Bigleaf.jl</code> contains two formulations  for the estimate of PET: the Priestley-Taylor equation, and the Penman-Monteith equation:</p><pre><code class="language-julia hljs">potential_ET!(thas, PriestleyTaylor(); G = thas.G)

# aerodynamic Ga_h and surface conductance Gs_mol must be computed before
potential_ET!(thas, PenmanMonteith();  G = thas.G,
        Gs_pot=quantile(skipmissing(thas.Gs_mol),0.95))
thas[24:26, Cols(:datetime, :ET_pot, :LE_pot)]</code></pre><div><div style = "float: left;"><span>3×3 DataFrame</span></div><div style = "clear: both;"></div></div><div class = "data-frame" style = "overflow-x: scroll;"><table class = "data-frame" style = "margin-bottom: 6px;"><thead><tr class = "header"><th class = "rowNumber" style = "font-weight: bold; text-align: right;">Row</th><th style = "text-align: left;">datetime</th><th style = "text-align: left;">ET_pot</th><th style = "text-align: left;">LE_pot</th></tr><tr class = "subheader headerLastRow"><th class = "rowNumber" style = "font-weight: bold; text-align: right;"></th><th title = "TimeZones.ZonedDateTime" style = "text-align: left;">ZonedDat…</th><th title = "Float64" style = "text-align: left;">Float64</th><th title = "Float64" style = "text-align: left;">Float64</th></tr></thead><tbody><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">1</td><td style = "text-align: left;">2014-06-01T17:00:00+00:00</td><td style = "text-align: right;">4.9276e-5</td><td style = "text-align: right;">121.47</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">2</td><td style = "text-align: left;">2014-06-01T17:30:00+00:00</td><td style = "text-align: right;">5.10116e-5</td><td style = "text-align: right;">125.745</td></tr><tr><td class = "rowNumber" style = "font-weight: bold; text-align: right;">3</td><td style = "text-align: left;">2014-06-01T18:00:00+00:00</td><td style = "text-align: right;">4.42427e-5</td><td style = "text-align: right;">109.097</td></tr></tbody></table></div><p>In the second calculation it is important to provide an estimate of aerodynamic  conductance, <span>$G_a$</span>, and the potential surface conductance under optimal conditions,  <span>$G_{s pot}$</span>.  Here, we have approximated <span>$G_{s pot}$</span> with the <span>$95^{\text{th}}$</span> percentile of all  <span>$G_s$</span> values of the site. </p><h2 id="Global-radiation"><a class="docs-heading-anchor" href="#Global-radiation">Global radiation</a><a id="Global-radiation-1"></a><a class="docs-heading-anchor-permalink" href="#Global-radiation" title="Permalink"></a></h2><p>Potential radiation for given time and latitude:</p><pre><code class="language-julia hljs">doy, hour = 160, 10.5
lat, long = 51.0, 11.5
potrad = potential_radiation(doy, hour, lat, long)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">1092.5166008044732</code></pre><p>Calculation is based on sun&#39;s altitude, one of the horizontal coordinates of its position.</p><pre><code class="language-julia hljs">using Plots, StatsPlots, DataFrames, Dates, Pipe, Suppressor
hours = 0:24
lat,long = 51.0, 13.6 # Dresden Germany
#deg2second = 24*3600/360
doy = 160
datetimes = DateTime(2021) .+Day(doy-1) .+ Hour.(hours) #.- Second(round(long*deg2second))
res3 = @pipe calc_sun_position_hor.(datetimes, lat, long) |&gt; DataFrame(_)</code></pre><img src="95258a0a.svg" alt="Example block output"/><p>The hour-angle at noon represents the difference to local time. In the following example solar time is about 55min ahead of local winter time.</p><pre><code class="language-julia hljs">summernoon = DateTime(2021) +Day(doy-1) + Hour(12)
sunpos = calc_sun_position_hor(summernoon, lat, long)
sunpos.hourangle * 24*60/(2*π) # convert angle to minutes</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">55.11417223753671</code></pre><h2 id="Unit-interconversions"><a class="docs-heading-anchor" href="#Unit-interconversions">Unit interconversions</a><a id="Unit-interconversions-1"></a><a class="docs-heading-anchor-permalink" href="#Unit-interconversions" title="Permalink"></a></h2><p>The package further provides a number of useful unit interconversions, which are straightforward to use (please make sure that the input variable is in the right unit, e_g. rH has to be between 0 and 1 and not in percent):</p><pre><code class="language-julia hljs"># VPD to vapor pressure (e, kPa)
VPD_to_e(2.0, 25.0)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">1.1600569164883336</code></pre><pre><code class="language-julia hljs"># vapor pressure to specific humidity (kg kg-1)
e_to_q(1.0, 100.0)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">0.006243600811065828</code></pre><pre><code class="language-julia hljs"># relative humidity to VPD (kPa)
rH_to_VPD(0.6, 25.0)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">1.2640227665953336</code></pre><pre><code class="language-julia hljs"># conductance from ms-1 to mol m-2 s-1
ms_to_mol(0.01, 25.0, 100.0) # mC, Tair, pressure</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">0.40339315662384556</code></pre><pre><code class="language-julia hljs"># umol CO2 m-2 s-1 to g C m-2 d-1
umolCO2_to_gC(20.0)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">20.755008000000004</code></pre><p>Many functions provide constant empirical parameters. Those can be changed by overriding the default values with  <a href="../BigleafConstants/#Bigleaf.BigleafConstants"><code>BigleafConstants</code></a>  and passing this Struct to the respective function.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><a class="docs-footer-nextpage" href="../metorological_variables/">- »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Tuesday 20 February 2024 14:48">Tuesday 20 February 2024</span>. Using Julia version 1.10.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
